
# Prometheus Alerts
- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=cloudfoundry_alerts?/release
  value: prometheus

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/rule_files/-
  value: /var/vcap/jobs/cloudfoundry_alerts/*.alerts

# Grafana Dashboards
- type: replace
  path: /instance_groups/name=grafana/jobs/name=cloudfoundry_dashboards?/release
  value: prometheus

- type: replace
  path: /instance_groups/name=grafana/jobs/name=grafana/properties/grafana/prometheus/dashboard_files?/-
  value: /var/vcap/jobs/cloudfoundry_dashboards/*.json


# Exporter jobs
- type: replace
  path: /instance_groups/-
  value:
    name: cf_firehose_((b_cld_metrics_environment))
    azs: [ z1, z2, z3 ]
    instances: 1
    vm_type: small
    stemcell: default
    vm_extensions: [monitoring]
    networks:
      - name: Support
    jobs:
      - name: cf_exporter
        release: prometheus
        properties:
          cf_exporter:
            cf:
              api_url: ((b_cld_api_url))
              client_id: cf_exporter
              client_secret: "((uaa_clients_cf_exporter_secret_b_cld))"
              deployment_name: cf
            metrics:
              environment: ((b_cld_metrics_environment))
      - name: firehose_exporter
        release: prometheus
        properties:
          firehose_exporter:
            doppler:
              url: ((b_cld_doppler_url))
              subscription_id: ((b_cld_metrics_environment))-root
              max_retry_count: 300
            uaa:
              url: ((b_cld_uaa_url))
              client_id: firehose_exporter
              client_secret: "((uaa_clients_firehose_exporter_secret_b_cld))"
            metrics:
              environment: ((b_cld_metrics_environment))
- type: replace
  path: /instance_groups/-
  value:
    name: cf_firehose_((d_cld_metrics_environment))
    azs: [ z1, z2, z3 ]
    instances: 1
    vm_type: small
    stemcell: default
    vm_extensions: [monitoring]
    networks:
      - name: Support
    jobs:
      - name: cf_exporter
        release: prometheus
        properties:
          cf_exporter:
            cf:
              api_url: ((d_cld_api_url))
              client_id: cf_exporter
              client_secret: "((uaa_clients_cf_exporter_secret_d_cld))"
              deployment_name: cf
            metrics:
              environment: ((d_cld_metrics_environment))
      - name: firehose_exporter
        release: prometheus
        properties:
          firehose_exporter:
            doppler:
              url: ((d_cld_doppler_url))
              subscription_id: ((d_cld_metrics_environment))-root
              max_retry_count: 300
            uaa:
              url: ((d_cld_uaa_url))
              client_id: firehose_exporter
              client_secret: "((uaa_clients_firehose_exporter_secret_d_cld))"
            metrics:
              environment: ((d_cld_metrics_environment))
- type: replace
  path: /instance_groups/-
  value:
    name: cf_firehose_((y_cld_metrics_environment))
    azs: [ z1, z2, z3 ]
    instances: 1
    vm_type: small
    stemcell: default
    vm_extensions: [monitoring]
    networks:
      - name: Support
    jobs:
      - name: cf_exporter
        release: prometheus
        properties:
          cf_exporter:
            cf:
              api_url: ((y_cld_api_url))
              client_id: cf_exporter
              client_secret: "((uaa_clients_cf_exporter_secret_y_cld))"
              deployment_name: cf
            metrics:
              environment: ((y_cld_metrics_environment))
      - name: firehose_exporter
        release: prometheus
        properties:
          firehose_exporter:
            doppler:
              url: ((y_cld_doppler_url))
              subscription_id: ((y_cld_metrics_environment))-root
              max_retry_count: 300
            uaa:
              url: ((y_cld_uaa_url))
              client_id: firehose_exporter
              client_secret: "((uaa_clients_firehose_exporter_secret_y_cld))"
            metrics:
              environment: ((y_cld_metrics_environment))

# Monitor Certwatch app - TODO tidy this up
- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: certwatch
    metrics_path: /metrics
    static_configs:
    - targets: [certmetrics.apps.y.cld.gov.au]

- type: replace
  path: /releases/-
  value:
    name: multi_bosh_exporter_boshrelease
    version: "2"
    sha1: "938d6305595fa45fc5293ddf5e8d6cb1eaa4fec4"
    url: "https://github.com/govau/multi_bosh_exporter_boshrelease/releases/download/2/multi_bosh_exporter_boshrelease-2.tgz"


# Exporter jobs
- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=bosh_exporter?
  value:
    name: multi_bosh_exporter
    release: multi_bosh_exporter_boshrelease
    properties:
      commands:
      - command: /var/vcap/packages/community_bosh_exporter/bin/bosh_exporter
        args:
        - "--bosh.url"
        - "((bosh_url))"
        - "--bosh.uaa.client-id"
        - "((bosh_username))"
        - "--bosh.uaa.client-secret"
        - "((bosh_password))"
        - "--bosh.ca-cert-file"
        - "/var/vcap/jobs/multi_bosh_exporter/config/m_bosh_ca_cert.pem"
        - "--metrics.environment"
        - "((metrics_environment))"
        - "--sd.filename"
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_m.json"
        - "--web.listen-address"
        - ":9190"
        files:
          /var/vcap/jobs/multi_bosh_exporter/config/m_bosh_ca_cert.pem: "((bosh_ca_cert))"
      - command: /var/vcap/packages/community_bosh_exporter/bin/bosh_exporter
        args:
        - "--bosh.url"
        - "((b_cld_bosh_url))"
        - "--bosh.uaa.client-id"
        - "((b_cld_bosh_client))"
        - "--bosh.uaa.client-secret"
        - "((b_cld_bosh_client_secret))"
        - "--bosh.ca-cert-file"
        - "/var/vcap/jobs/multi_bosh_exporter/config/b_bosh_ca_cert.pem"
        - "--metrics.environment"
        - "((b_cld_metrics_environment))"
        - "--sd.filename"
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_b.json"
        - "--web.listen-address"
        - ":9191"
        files:
          /var/vcap/jobs/multi_bosh_exporter/config/b_bosh_ca_cert.pem: "((b_cld_bosh_ca_cert))"
      - command: /var/vcap/packages/community_bosh_exporter/bin/bosh_exporter
        args:
        - "--bosh.url"
        - "((y_cld_bosh_url))"
        - "--bosh.uaa.client-id"
        - "((y_cld_bosh_client))"
        - "--bosh.uaa.client-secret"
        - "((y_cld_bosh_client_secret))"
        - "--bosh.ca-cert-file"
        - "/var/vcap/jobs/multi_bosh_exporter/config/y_bosh_ca_cert.pem"
        - "--metrics.environment"
        - "((y_cld_metrics_environment))"
        - "--sd.filename"
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_y.json"
        - "--web.listen-address"
        - ":9192"
        files:
          /var/vcap/jobs/multi_bosh_exporter/config/y_bosh_ca_cert.pem: "((y_cld_bosh_ca_cert))"
      - command: /var/vcap/packages/community_bosh_exporter/bin/bosh_exporter
        args:
        - "--bosh.url"
        - "((d_cld_bosh_url))"
        - "--bosh.uaa.client-id"
        - "((d_cld_bosh_client))"
        - "--bosh.uaa.client-secret"
        - "((d_cld_bosh_client_secret))"
        - "--bosh.ca-cert-file"
        - "/var/vcap/jobs/multi_bosh_exporter/config/d_bosh_ca_cert.pem"
        - "--metrics.environment"
        - "((d_cld_metrics_environment))"
        - "--sd.filename"
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_d.json"
        - "--web.listen-address"
        - ":9193"
        files:
          /var/vcap/jobs/multi_bosh_exporter/config/d_bosh_ca_cert.pem: "((d_cld_bosh_ca_cert))"

# Prometheus Alerts
- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=bosh_alerts?/release
  value: prometheus

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/rule_files/-
  value: /var/vcap/jobs/bosh_alerts/*.alerts.yml

# Grafana Dashboards
- type: replace
  path: /instance_groups/name=grafana/jobs/name=bosh_dashboards?/release
  value: prometheus

- type: replace
  path: /instance_groups/name=grafana/jobs/name=grafana/properties/grafana/prometheus/dashboard_folders/name=BOSH?/files/-
  value: /var/vcap/jobs/bosh_dashboards/bosh*.json

- type: replace
  path: /instance_groups/name=grafana/jobs/name=grafana/properties/grafana/prometheus/dashboard_folders/name=Prometheus?/files/-
  value: /var/vcap/jobs/bosh_dashboards/prometheus*.json

# Prometheus Scrape Config
- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: bosh
    scrape_interval: 2m
    scrape_timeout: 1m
    static_configs:
      - targets:
        - localhost:9190
        - localhost:9191
        - localhost:9192
        - localhost:9193

# Service Discovery
- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: bosh_tsdb
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: bosh_tsdb_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9194"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: cadvisor
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: cadvisor
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:8080"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: cf
    scrape_interval: 4m
    scrape_timeout: 2m
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: cf_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9193"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: collectd
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: collectd_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9103"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: consul
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: consul_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9107"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: elasticsearch
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: elasticsearch_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9114"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: concourse
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: atc
        action: keep
      - source_labels:
        - __meta_bosh_deployment
        regex: "(.*)"
        target_label: bosh_deployment
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9391"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: firehose
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: firehose_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9186"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: grafana
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: grafana
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:3000"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: graphite
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: graphite_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9108"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: haproxy
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: haproxy_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9101"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: influxdb
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: influxdb_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9122"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: kubernetes
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: kube_state_metrics_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9188"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: memcached
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: memcached_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9150"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: mongodb
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: mongodb_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9001"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: mysql
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: mysqld_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9104"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: nats
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: nats_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9118"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: node
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: node_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9100"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: postgres
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: postgres_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9187"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/job_name=prometheus
  value:
    job_name: prometheus
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: prometheus\d?
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9090"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: pushgateway
    honor_labels: true
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: pushgateway
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9091"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: rabbitmq
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: rabbitmq_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9125"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: redis
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: redis_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9121"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: shield
    scrape_interval: 4m
    scrape_timeout: 2m
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: shield_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9179"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: stackdriver
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: stackdriver_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9255"

- type: replace
  path: /instance_groups/name=prometheus2/jobs/name=prometheus2/properties/prometheus/scrape_configs/-
  value:
    job_name: statsd
    file_sd_configs:
      - files:
        - "/var/vcap/store/multi_bosh_exporter/bosh_target_groups_*.json"
    relabel_configs:
      - source_labels:
        - __meta_bosh_job_process_name
        regex: statsd_exporter
        action: keep
      - source_labels:
        - __address__
        regex: "(.*)"
        target_label: __address__
        replacement: "${1}:9102"
